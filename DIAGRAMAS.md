# ๐จ Diagramas Visuales - Dependency Injection

## ๐ 1. Arquitectura del Sistema

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         CLIENTE                                 โ
โ                    (Navegador / Postman)                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ HTTP Request
                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      API LAYER                                  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ ProductsController                                        โ โ
โ  โ โข Recibe IProductService por constructor                 โ โ
โ  โ โข Define acciones HTTP (Get, Post, Put, Delete)          โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ Program.cs                                                โ โ
โ  โ โข Configura Dependency Injection                          โ โ
โ  โ โข Registra Controllers                                    โ โ
โ  โ โข Middleware Pipeline                                     โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ Llama a
                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                   APPLICATION LAYER                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ ProductService : IProductService                          โ โ
โ  โ โข Lรณgica de Negocio                                       โ โ
โ  โ โข Transformaciรณn de Datos (Entity โ DTO)                 โ โ
โ  โ โข Orquestaciรณn de Repositorios                            โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ Usa
                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                     DOMAIN LAYER                                โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ IProductRepository (INTERFAZ)                             โ โ
โ  โ โข Define el CONTRATO                                      โ โ
โ  โ โข No tiene implementaciรณn                                 โ โ
โ  โ โข Independiente de cualquier framework                    โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ Product (ENTIDAD)                                         โ โ
โ  โ โข Modelo del Dominio                                      โ โ
โ  โ โข Sin dependencias externas                               โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ
                          โ Implementa
                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                 INFRASTRUCTURE LAYER                            โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ ProductRepository : IProductRepository                    โ โ
โ  โ โข Implementaciรณn CONCRETA                                 โ โ
โ  โ โข Acceso a Base de Datos                                  โ โ
โ  โ โข Lรณgica de Persistencia                                  โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ
                          โ
                  โโโโโโโโโโโโโโโโโ
                  โ   DATABASE    โ
                  โโโโโโโโโโโโโโโโโ
```

## ๐ 2. Flujo de Dependency Injection

```
INICIO: Aplicaciรณn arranca
โ
โโ Program.cs ejecuta
โ  โ
โ  โโ PASO 1: Crear WebApplicationBuilder
โ  โ  var builder = WebApplication.CreateBuilder(args);
โ  โ
โ  โโ PASO 2: Configurar Servicios
โ  โ  โ
โ  โ  โโ builder.Services.AddApplicationLayer();
โ  โ  โ  โ
โ  โ  โ  โโ Registra: IProductService โ ProductService (Scoped)
โ  โ  โ     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ  โ     โ Contenedor DI:                         โ
โ  โ  โ     โ  [IProductService] โ [ProductService]  โ
โ  โ  โ     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ  โ
โ  โ  โโ builder.Services.AddInfrastructureLayer();
โ  โ     โ
โ  โ     โโ Registra: IProductRepository โ ProductRepository (Scoped)
โ  โ        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ        โ Contenedor DI:                                 โ
โ  โ        โ  [IProductService] โ [ProductService]          โ
โ  โ        โ  [IProductRepository] โ [ProductRepository]    โ
โ  โ        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ
โ  โโ PASO 3: Construir WebApplication
โ  โ  var app = builder.Build();
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ  โ Contenedor DI estรก LISTO                   โ
โ  โ  โ Conoce todas las dependencias              โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ
โ  โโ PASO 4: Mapear Controllers
โ     app.MapControllers();
โ     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ     โ ASP.NET Core escanea y registra todos los โ
โ     โ controllers con atributo [ApiController]   โ
โ     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ
โโ FIN: Aplicaciรณn esperando requests

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

DURANTE UNA REQUEST: Cliente llama GET /api/products
โ
โโ Request llega al controller
โ  ProductsController.GetAll()
โ  โ
โ  โ Constructor: ProductsController(IProductService service)
โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ ASP.NET Core ve que necesita IProductService              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ Contenedor DI busca en registros:                         โ
โ  โ   IProductService โ ProductService                         โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ Contenedor DI intenta crear ProductService                โ
โ  โ Constructor: ProductService(IProductRepository repo)      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ Contenedor DI ve que necesita IProductRepository          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ Contenedor DI busca en registros:                         โ
โ  โ   IProductRepository โ ProductRepository                   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ Contenedor DI crea ProductRepository                      โ
โ  โ   new ProductRepository()                                  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ Contenedor DI crea ProductService                         โ
โ  โ   new ProductService(productRepositoryInstance)            โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ Contenedor DI crea ProductsController                     โ
โ  โ   new ProductsController(productServiceInstance)           โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                      โ
โโ Controller ejecuta la acciรณn con el servicio inyectado
โ  public async Task<IActionResult> GetAll()
โ  {
โ      var products = await _productService.GetAllProductsAsync();
โ                             โ
โ                             โโ Llama a ProductService.GetAllProductsAsync()
โ                             โ       โ
โ                             โ       โโ Llama a _repository.GetAllAsync()
โ                             โ              โ
โ                             โ              โโ ProductRepository obtiene datos
โ                             โ                     โ
โ                             โ                     โโ Retorna List<Product>
โ                             โ
โ                             โโ Convierte a List<ProductDto>
โ      return Ok(products);
โ  }
โ
โโ Response retornada al cliente
```

## ๐ฏ 3. Inyecciรณn en Cadena

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  INYECCIรN EN CADENA                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ProductsController necesita โ IProductService
                         โ
                         โ
                    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                    โ   Contenedor DI resuelve:   โ
                    โ   IProductService           โ
                    โ         โ                   โ
                    โ   ProductService            โ
                    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โ ProductService constructor necesita
                         โ
                    IProductRepository
                         โ
                         โ
                    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                    โ   Contenedor DI resuelve:   โ
                    โ   IProductRepository        โ
                    โ         โ                   โ
                    โ   ProductRepository         โ
                    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โ
            โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
            โ Todas las dependencias resueltas โ
            โ                                  โ
            โ ProductRepository creado         โ
            โ        โ                         โ
            โ ProductService creado con        โ
            โ   ProductRepository inyectado    โ
            โ        โ                         โ
            โ ProductsController recibe        โ
            โ   ProductService                 โ
            โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐๏ธ 4. Estructura de Dependencias

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              DIRECCIรN DE LAS DEPENDENCIAS                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโ
โ     API      โ  Depende de โ  Application + Infrastructure
โโโโโโโโฌโโโโโโโโ
       โ
       โ
โโโโโโโโโโโโโโโโ
โ Application  โ  Depende de โ  Domain
โโโโโโโโฌโโโโโโโโ
       โ
       โ
โโโโโโโโโโโโโโโโ
โ   Domain     โ  โ No depende de NADIE (Centro del sistema)
โโโโโโโโโโโโโโโโ
       โ
       โ
โโโโโโโโดโโโโโโโโ
โInfrastructureโ  Depende de โ  Domain (Implementa interfaces)
โโโโโโโโโโโโโโโโ

NOTA: Infrastructure implementa interfaces de Domain,
      pero Domain NO conoce Infrastructure.
      ยกEsto es la INVERSIรN de dependencias!
```

## ๐ 5. Comparaciรณn: Con vs Sin DI

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    SIN DEPENDENCY INJECTION                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

public class ProductService
{
    private ProductRepository _repository;
    
    public ProductService()
    {
        _repository = new ProductRepository(); โ โ Acoplamiento fuerte
    }                                            โ Difรญcil de testear
}                                                โ No se puede cambiar impl.

Problemas:
โข ProductService estรก acoplado a ProductRepository
โข No puedes cambiar la implementaciรณn sin modificar ProductService
โข Imposible inyectar mocks para testing
โข Responsabilidad de crear dependencias en el servicio


โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    CON DEPENDENCY INJECTION                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

public class ProductService
{
    private readonly IProductRepository _repository;
    
    public ProductService(IProductRepository repository) โ โ Desacoplado
    {                                                       โ Testeable
        _repository = repository;                           โ Flexible
    }
}

Ventajas:
โข ProductService depende de ABSTRACCIรN (IProductRepository)
โข Puedes cambiar implementaciรณn sin tocar ProductService
โข Fรกcil inyectar mocks para testing
โข Responsabilidad de crear dependencias en el contenedor DI
```

## โฑ๏ธ 6. Service Lifetimes Visualizados

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      TRANSIENT                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

Request 1:
  Endpoint A โ Logger A (nueva instancia)
  Service B  โ Logger B (nueva instancia)
  Service C  โ Logger C (nueva instancia)

Request 2:
  Endpoint D โ Logger D (nueva instancia)
  Service E  โ Logger E (nueva instancia)

Cada solicitud = Nueva instancia
Cada inyecciรณn = Nueva instancia


โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                        SCOPED                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

Request 1:
  Endpoint A โ Repository A (nueva instancia)
  Service B  โ Repository A (misma instancia)
  Service C  โ Repository A (misma instancia)

Request 2:
  Endpoint D โ Repository B (nueva instancia)
  Service E  โ Repository B (misma instancia)

Cada request = Nueva instancia
Dentro del request = Misma instancia


โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      SINGLETON                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

Request 1:
  Endpoint A โ Config A (nueva instancia)
  Service B  โ Config A (misma instancia)

Request 2:
  Endpoint C โ Config A (misma instancia)
  Service D  โ Config A (misma instancia)

Request N:
  Endpoint X โ Config A (misma instancia)

Toda la aplicaciรณn = Una รบnica instancia
```

## ๐ 7. Ejemplo Real: Request Completo

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              GET /api/products - FLUJO COMPLETO                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

1. Cliente
   โโ> HTTP GET /api/products
        โ
        โ
2. ASP.NET Core
   โโ> Enruta a: ProductsController.GetAll()
        โ
        โ
3. Contenedor DI
   โโ> Crea ProductsController
        โ
        โโ> Constructor necesita: IProductService
             โ
             โโ> Busca registro: IProductService โ ProductService
             โ
             โโ> Crea Scope (nueva instancia para esta request)
             โ
             โโ> Crea ProductService
                  โ
                  โโ> Constructor necesita: IProductRepository
                       โ
                       โโ> Busca registro: IProductRepository โ ProductRepository
                       โ
                       โโ> Crea ProductRepository (mismo Scope)
        โ
        โ
4. Controller ejecuta acciรณn
   โโ> _productService.GetAllProductsAsync()
        โ
        โ
5. ProductService
   โโ> _repository.GetAllAsync()
        โ
        โ
6. ProductRepository
   โโ> Obtiene datos de _products (lista en memoria)
        โ
        โ
7. Retorna List<Product>
   โโ> Vuelve a ProductService
        โ
        โ
8. ProductService
   โโ> Convierte Product โ ProductDto
        โ
        โ
9. Retorna List<ProductDto>
   โโ> Vuelve al Controller
        โ
        โ
10. Controller
    โโ> Ok(products)
         โ
         โ
11. ASP.NET Core
    โโ> Serializa a JSON
         โ
         โ
12. HTTP Response
    โโ> Status 200 OK
        Body: [{"id":1,"name":"Laptop",...},...]
         โ
         โ
13. Contenedor DI
    โโ> Dispone instancias Scoped (fin de request)
         โ
         โโ> ProductService โ Disposed
         โโ> ProductRepository โ Disposed
```

## ๐งช 8. Testing con Mocks

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  TESTING CON DEPENDENCY INJECTION              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

// Test sin DI (imposible sin modificar ProductService)
โ No se puede hacer

// Test con DI (fรกcil con mocks)
โ

[Fact]
public async Task GetAllProducts_ReturnsProducts()
{
    // Arrange
    var mockRepo = new Mock<IProductRepository>();
                        โ
                        โโ Mock de la interfaz
    
    mockRepo.Setup(r => r.GetAllAsync())
            .ReturnsAsync(new List<Product> { /* test data */ });
             โ
             โโ Configurar comportamiento del mock
    
    var service = new ProductService(mockRepo.Object);
                                          โ
                                          โโ Inyectar mock
    
    // Act
    var result = await service.GetAllProductsAsync();
    
    // Assert
    Assert.NotEmpty(result);
    mockRepo.Verify(r => r.GetAllAsync(), Times.Once);
             โ
             โโ Verificar que se llamรณ al mรฉtodo
}

Diagrama del flujo:

Test
 โโ> Crea Mock de IProductRepository
      โโ> Configura comportamiento esperado
           โโ> Inyecta mock en ProductService
                โโ> Ejecuta mรฉtodo del servicio
                     โโ> Servicio usa el mock (no la impl. real)
                          โโ> Verifica comportamiento
```

---

## ๐ Leyenda de Sรญmbolos

- `โ` : Dependencia / Flujo
- `โ` : Siguiente paso
- `โ` : Referencia / Implementa
- `โโโ` : Contenedor / Bloque
- `โ` : Correcto / Ventaja
- `โ` : Incorrecto / Problema
- `โ` : Secciรณn importante
- `โฌ` : Divisiรณn / Bifurcaciรณn

---

๐ก **Tip**: Imprime estos diagramas y sรญguelos mientras exploras el cรณdigo!
